{% extends "base.html" %}

{% block title %}{{ _("accounts.title") }} - xspider Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-twitter"></i> {{ _("accounts.title") }}</h2>
        <p class="text-muted">{{ _("accounts.description") }}</p>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
            <i class="bi bi-plus-lg"></i> {{ _("accounts.add_account") }}
        </button>
        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#importModal">
            <i class="bi bi-upload"></i> {{ _("common.import") }}
        </button>
        <button class="btn btn-outline-secondary" onclick="checkAllAccounts()">
            <i class="bi bi-check-circle"></i> {{ _("accounts.check_all") }}
        </button>
        <a href="/admin/accounts/groups" class="btn btn-outline-primary">
            <i class="bi bi-collection"></i> {{ _("groups.manage_groups") }}
        </a>
        <a href="/admin/accounts/stats" class="btn btn-outline-info">
            <i class="bi bi-graph-up"></i> {{ _("stats.title") }}
        </a>
    </div>
</div>

<!-- Filters -->
<div class="row mb-3">
    <div class="col-md-3">
        <select class="form-select" id="status-filter" onchange="loadAccounts()">
            <option value="">{{ _("accounts.all_status") }}</option>
            <option value="active">{{ _("accounts.active") }}</option>
            <option value="rate_limited">{{ _("accounts.rate_limited") }}</option>
            <option value="banned">{{ _("accounts.banned") }}</option>
            <option value="needs_verify">{{ _("accounts.needs_verify") }}</option>
            <option value="error">{{ _("accounts.error") }}</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="group-filter" onchange="loadAccounts()">
            <option value="">{{ _("groups.all_groups") }}</option>
            <option value="ungrouped">{{ _("groups.ungrouped") }}</option>
        </select>
    </div>
    <div class="col-md-3">
        <button class="btn btn-outline-secondary" id="batch-assign-btn" onclick="showBatchAssignModal()" disabled>
            <i class="bi bi-collection"></i> {{ _("groups.batch_assign") }}
        </button>
    </div>
</div>

<!-- Accounts Table -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                        <th>{{ _("accounts.id") }}</th>
                        <th>{{ _("accounts.name") }}</th>
                        <th>{{ _("groups.title") }}</th>
                        <th>{{ _("accounts.status") }}</th>
                        <th>{{ _("accounts.requests") }}</th>
                        <th>{{ _("accounts.errors") }}</th>
                        <th>{{ _("accounts.last_used") }}</th>
                        <th>{{ _("common.actions") }}</th>
                    </tr>
                </thead>
                <tbody id="accounts-table-body">
                    <tr>
                        <td colspan="9" class="text-center py-4">{{ _("common.loading") }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Batch Assign Modal -->
<div class="modal fade" id="batchAssignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("groups.batch_assign") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="return batchAssignAccounts(event)">
                <div class="modal-body">
                    <p id="batch-assign-info"></p>
                    <div class="mb-3">
                        <label class="form-label">{{ _("groups.select_group") }}</label>
                        <select class="form-select" id="batch-assign-group">
                            <option value="">{{ _("groups.ungrouped") }}</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("common.cancel") }}</button>
                    <button type="submit" class="btn btn-primary">{{ _("groups.assign_to_group") }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Account Modal -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("accounts.add_account") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="return addAccount(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{{ _("accounts.name") }} ({{ _("common.optional") }})</label>
                        <input type="text" class="form-control" id="account-name" placeholder="{{ _('accounts.account_nickname') }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _("accounts.bearer_token") }}</label>
                        <textarea class="form-control" id="bearer-token" rows="2" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _("accounts.ct0_token") }}</label>
                        <input type="text" class="form-control" id="ct0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _("accounts.auth_token") }}</label>
                        <input type="text" class="form-control" id="auth-token" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _("common.notes") }} ({{ _("common.optional") }})</label>
                        <textarea class="form-control" id="account-notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("common.cancel") }}</button>
                    <button type="submit" class="btn btn-primary">{{ _("accounts.add_account") }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("accounts.import_accounts") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="return importAccounts(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{{ _("accounts.import_format") }}</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="import-format" id="format-standard" value="standard" checked onchange="updateImportHint()">
                            <label class="btn btn-outline-primary" for="format-standard">{{ _("accounts.format_standard") }}</label>
                            <input type="radio" class="btn-check" name="import-format" id="format-android" value="android" onchange="updateImportHint()">
                            <label class="btn btn-outline-primary" for="format-android">{{ _("accounts.format_android") }}</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _("accounts.json_array") }}</label>
                        <textarea class="form-control" id="import-json" rows="10" required
                            placeholder='[{"bearer_token": "...", "ct0": "...", "auth_token": "..."}]'></textarea>
                    </div>
                    <div class="alert alert-info mb-0" id="import-hint">
                        <small>{{ _("accounts.import_hint") }}</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("common.cancel") }}</button>
                    <button type="submit" class="btn btn-primary">{{ _("common.import") }}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedAccountIds = new Set();

async function loadGroups() {
    try {
        const response = await fetch('/api/account-groups/');
        if (!response.ok) return;

        const data = await response.json();
        const groupFilter = document.getElementById('group-filter');
        const batchAssignGroup = document.getElementById('batch-assign-group');

        // Preserve current selections
        const currentFilter = groupFilter.value;

        // Clear and rebuild group filter options
        groupFilter.innerHTML = `
            <option value="">${t('groups.all_groups')}</option>
            <option value="ungrouped">${t('groups.ungrouped')}</option>
        `;

        // Clear and rebuild batch assign options
        batchAssignGroup.innerHTML = `<option value="">${t('groups.ungrouped')}</option>`;

        data.groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.name + (group.is_active ? '' : ` (${t('status.inactive')})`);
            groupFilter.appendChild(option);

            const assignOption = option.cloneNode(true);
            batchAssignGroup.appendChild(assignOption);
        });

        // Restore selection
        groupFilter.value = currentFilter;
    } catch (error) {
        console.error('Error loading groups:', error);
    }
}

async function loadAccounts() {
    const statusFilter = document.getElementById('status-filter').value;
    const groupFilter = document.getElementById('group-filter').value;

    let url = '/api/accounts/?';
    const params = [];

    if (statusFilter) {
        params.push(`status_filter=${statusFilter}`);
    }
    if (groupFilter === 'ungrouped') {
        params.push('ungrouped=true');
    } else if (groupFilter) {
        params.push(`group_id=${groupFilter}`);
    }

    url += params.join('&');

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load accounts');

        const accounts = await response.json();
        renderAccounts(accounts);
    } catch (error) {
        console.error('Error loading accounts:', error);
        document.getElementById('accounts-table-body').innerHTML =
            `<tr><td colspan="9" class="text-center text-danger">${t('common.error')}</td></tr>`;
    }
}

function renderAccounts(accounts) {
    const tbody = document.getElementById('accounts-table-body');

    // Clear selections
    selectedAccountIds.clear();
    document.getElementById('select-all').checked = false;
    updateBatchButton();

    if (accounts.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">${t('accounts.no_accounts')}</td></tr>`;
        return;
    }

    tbody.innerHTML = accounts.map(account => {
        const statusBadge = getStatusBadge(account.status);
        const lastUsed = account.last_used_at ? formatDate(account.last_used_at) : t('common.never');
        const groupBadge = account.group_name
            ? `<span class="badge bg-primary">${escapeHtml(account.group_name)}</span>`
            : `<span class="badge bg-secondary">${t('groups.ungrouped')}</span>`;

        return `
            <tr>
                <td><input type="checkbox" class="account-checkbox" value="${account.id}" onchange="toggleAccountSelect(${account.id})"></td>
                <td>${account.id}</td>
                <td>${account.name || '-'}</td>
                <td>${groupBadge}</td>
                <td>${statusBadge}</td>
                <td>${account.request_count}</td>
                <td>${account.error_count > 0 && account.last_error
                    ? `<span class="text-danger" style="cursor: help;" title="${escapeHtml(account.last_error)}"
                         data-bs-toggle="tooltip" data-bs-placement="top">
                         ${account.error_count} <i class="bi bi-exclamation-circle"></i>
                       </span>`
                    : account.error_count}</td>
                <td>${lastUsed}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="checkAccount(${account.id})" title="${t('accounts.check')}">
                            <i class="bi bi-check-circle"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="resetCounters(${account.id})" title="${t('accounts.reset')}">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteAccount(${account.id})" title="${t('common.delete')}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');

    // Initialize Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
}

function toggleSelectAll() {
    const checked = document.getElementById('select-all').checked;
    const checkboxes = document.querySelectorAll('.account-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checked;
        if (checked) {
            selectedAccountIds.add(parseInt(cb.value));
        } else {
            selectedAccountIds.delete(parseInt(cb.value));
        }
    });
    updateBatchButton();
}

function toggleAccountSelect(accountId) {
    if (selectedAccountIds.has(accountId)) {
        selectedAccountIds.delete(accountId);
    } else {
        selectedAccountIds.add(accountId);
    }
    updateBatchButton();
}

function updateBatchButton() {
    const btn = document.getElementById('batch-assign-btn');
    btn.disabled = selectedAccountIds.size === 0;
}

function showBatchAssignModal() {
    if (selectedAccountIds.size === 0) return;
    document.getElementById('batch-assign-info').textContent =
        t('groups.accounts_assigned').replace('{count}', selectedAccountIds.size);
    new bootstrap.Modal(document.getElementById('batchAssignModal')).show();
}

async function batchAssignAccounts(event) {
    event.preventDefault();

    const groupId = document.getElementById('batch-assign-group').value;
    const url = `/api/accounts/batch-assign-group${groupId ? `?group_id=${groupId}` : '?group_id='}`;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ account_ids: Array.from(selectedAccountIds) })
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('batchAssignModal')).hide();
            selectedAccountIds.clear();
            loadAccounts();
            loadGroups();
        } else {
            const error = await response.json();
            alert(error.detail || t('common.operation_failed'));
        }
    } catch (error) {
        alert(t('common.error'));
    }

    return false;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getStatusBadge(status) {
    const badges = {
        'active': `<span class="badge bg-success">${t('status.active')}</span>`,
        'rate_limited': `<span class="badge bg-warning">${t('status.rate_limited')}</span>`,
        'banned': `<span class="badge bg-danger">${t('status.banned')}</span>`,
        'needs_verify': `<span class="badge bg-info">${t('status.needs_verify')}</span>`,
        'error': `<span class="badge bg-secondary">${t('status.error')}</span>`
    };
    return badges[status] || status;
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleString();
}

async function addAccount(event) {
    event.preventDefault();

    const data = {
        name: document.getElementById('account-name').value || null,
        bearer_token: document.getElementById('bearer-token').value,
        ct0: document.getElementById('ct0').value,
        auth_token: document.getElementById('auth-token').value,
        notes: document.getElementById('account-notes').value || null
    };

    try {
        const response = await fetch('/api/accounts/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
            loadAccounts();
        } else {
            const error = await response.json();
            alert(error.detail || t('common.operation_failed'));
        }
    } catch (error) {
        alert(t('common.error'));
    }

    return false;
}

function updateImportHint() {
    const format = document.querySelector('input[name="import-format"]:checked').value;
    const hintEl = document.getElementById('import-hint');
    const textareaEl = document.getElementById('import-json');

    if (format === 'android') {
        hintEl.innerHTML = `<small>${t('accounts.import_android_hint')}</small>`;
        textareaEl.placeholder = '[{"Uid": "123", "Cookies": [{"name": "ct0", "value": "..."}, {"name": "auth_token", "value": "..."}]}]';
    } else {
        hintEl.innerHTML = `<small>${t('accounts.import_hint')}</small>`;
        textareaEl.placeholder = '[{"bearer_token": "...", "ct0": "...", "auth_token": "..."}]';
    }
}

async function importAccounts(event) {
    event.preventDefault();

    const format = document.querySelector('input[name="import-format"]:checked').value;

    try {
        const jsonText = document.getElementById('import-json').value;
        const data = JSON.parse(jsonText);

        let url, body;
        if (format === 'android') {
            // Android format: array of accounts with Uid, Cookies, UserInfo
            url = '/api/accounts/import-android';
            body = JSON.stringify({ accounts: Array.isArray(data) ? data : [data] });
        } else {
            // Standard format
            url = '/api/accounts/batch-import';
            body = JSON.stringify({ accounts: Array.isArray(data) ? data : [data] });
        }

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: body
        });

        if (response.ok) {
            const result = await response.json();
            bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();

            if (format === 'android') {
                alert(t('accounts.android_import_success')
                    .replace('{imported}', result.imported)
                    .replace('{skipped}', result.skipped));
            } else {
                alert(t('accounts.import_success').replace('{count}', result.length));
            }
            loadAccounts();
        } else {
            const error = await response.json();
            alert(error.detail || t('common.operation_failed'));
        }
    } catch (error) {
        console.error('Import error:', error);
        alert(t('accounts.invalid_json'));
    }

    return false;
}

async function checkAccount(accountId) {
    try {
        const response = await fetch(`/api/accounts/${accountId}/check`, { method: 'POST' });
        if (response.ok) {
            const result = await response.json();
            alert(`${t('common.status')}: ${result.status}${result.error_message ? '\n' + result.error_message : ''}`);
            loadAccounts();
        }
    } catch (error) {
        alert(t('common.error'));
    }
}

async function checkAllAccounts() {
    if (!confirm(t('accounts.confirm_check_all'))) return;

    try {
        const response = await fetch('/api/accounts/check-all', { method: 'POST' });
        if (response.ok) {
            alert(t('common.operation_success'));
            loadAccounts();
        }
    } catch (error) {
        alert(t('common.error'));
    }
}

async function resetCounters(accountId) {
    if (!confirm(t('accounts.confirm_reset'))) return;

    try {
        const response = await fetch(`/api/accounts/${accountId}/reset-counters`, { method: 'POST' });
        if (response.ok) {
            loadAccounts();
        }
    } catch (error) {
        alert(t('common.error'));
    }
}

async function deleteAccount(accountId) {
    if (!confirm(t('accounts.confirm_delete'))) return;

    try {
        const response = await fetch(`/api/accounts/${accountId}`, { method: 'DELETE' });
        if (response.ok) {
            loadAccounts();
        }
    } catch (error) {
        alert(t('common.error'));
    }
}

document.addEventListener('DOMContentLoaded', () => {
    loadGroups();
    loadAccounts();
});
</script>
{% endblock %}
