{% extends "base.html" %}

{% block title %}{{ _("profile.title") }} - xspider{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-person"></i> {{ _("profile.title") }}</h2>
        <p class="text-muted">{{ _("profile.description") }}</p>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <!-- Profile Info -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-person-circle"></i> {{ _("profile.account_info") }}
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label text-muted">{{ _("profile.username") }}</label>
                    <p class="form-control-plaintext"><strong id="profile-username">{{ user.username }}</strong></p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">{{ _("profile.email") }}</label>
                    <p class="form-control-plaintext" id="profile-email">{{ _("common.loading") }}</p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">{{ _("profile.role") }}</label>
                    <p class="form-control-plaintext" id="profile-role">
                        {% if user.role.value == 'admin' %}
                        <span class="badge bg-danger">{{ _("users.admin") }}</span>
                        {% else %}
                        <span class="badge bg-primary">{{ _("users.user") }}</span>
                        {% endif %}
                    </p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">{{ _("credits.current_balance") }}</label>
                    <p class="form-control-plaintext">
                        <span class="badge bg-warning text-dark fs-5" id="profile-credits">{{ user.credits }}</span>
                    </p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">{{ _("profile.member_since") }}</label>
                    <p class="form-control-plaintext" id="profile-created">{{ _("common.loading") }}</p>
                </div>
            </div>
        </div>

        <!-- Change Password -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-key"></i> {{ _("profile.change_password") }}
            </div>
            <div class="card-body">
                <form onsubmit="return changePassword(event)">
                    <div class="mb-3">
                        <label class="form-label">{{ _("profile.current_password") }}</label>
                        <input type="password" class="form-control" id="current-password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _("profile.new_password") }}</label>
                        <input type="password" class="form-control" id="new-password" required minlength="6">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _("profile.confirm_password") }}</label>
                        <input type="password" class="form-control" id="confirm-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> {{ _("profile.update_password") }}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <!-- Usage Stats -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> {{ _("searches.title") }}
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <h3 id="stat-searches">-</h3>
                        <small class="text-muted">{{ _("searches.title") }}</small>
                    </div>
                    <div class="col-4">
                        <h3 id="stat-influencers">-</h3>
                        <small class="text-muted">{{ _("searches.influencers_found") }}</small>
                    </div>
                    <div class="col-4">
                        <h3 id="stat-credits-used">-</h3>
                        <small class="text-muted">{{ _("searches.credits_used") }}</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Searches -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> {{ _("searches.search_history") }}
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush" id="recent-searches-list">
                    <li class="list-group-item text-center text-muted">{{ _("common.loading") }}</li>
                </ul>
            </div>
            <div class="card-footer text-center">
                <a href="/searches" class="text-decoration-none">{{ _("searches.view_results") }}</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadProfile() {
    try {
        const response = await fetch('/api/auth/me');
        if (!response.ok) throw new Error('Failed to load profile');

        const user = await response.json();

        document.getElementById('profile-email').textContent = user.email;
        document.getElementById('profile-credits').textContent = user.credits;
        document.getElementById('profile-created').textContent = new Date(user.created_at).toLocaleDateString();
    } catch (error) {
        console.error('Error loading profile:', error);
    }
}

async function loadStats() {
    try {
        const [summaryRes, searchesRes] = await Promise.all([
            fetch('/api/credits/summary'),
            fetch('/api/searches/?page=1&page_size=5')
        ]);

        if (summaryRes.ok) {
            const summary = await summaryRes.json();
            document.getElementById('stat-credits-used').textContent = summary.total_spent.total;
        }

        if (searchesRes.ok) {
            const searches = await searchesRes.json();
            document.getElementById('stat-searches').textContent = searches.length;

            const totalInfluencers = searches.reduce((sum, s) => sum + (s.seeds_found || 0), 0);
            document.getElementById('stat-influencers').textContent = totalInfluencers;

            const list = document.getElementById('recent-searches-list');
            if (searches.length === 0) {
                list.innerHTML = `<li class="list-group-item text-center text-muted">${t('searches.no_searches')}</li>`;
            } else {
                list.innerHTML = searches.map(s => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <a href="/searches/${s.id}" class="text-decoration-none">
                                ${s.keywords.substring(0, 30)}${s.keywords.length > 30 ? '...' : ''}
                            </a>
                            <br>
                            <small class="text-muted">${new Date(s.created_at).toLocaleDateString()}</small>
                        </div>
                        ${getStatusBadge(s.status)}
                    </li>
                `).join('');
            }
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

function getStatusBadge(status) {
    const badges = {
        'pending': `<span class="badge bg-secondary">${t('status.pending')}</span>`,
        'running': `<span class="badge bg-primary">${t('status.running')}</span>`,
        'completed': `<span class="badge bg-success">${t('status.completed')}</span>`,
        'failed': `<span class="badge bg-danger">${t('status.failed')}</span>`
    };
    return badges[status] || status;
}

async function changePassword(event) {
    event.preventDefault();

    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;

    if (newPassword !== confirmPassword) {
        alert(t('profile.password_mismatch'));
        return false;
    }

    try {
        const response = await fetch('/api/auth/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        });

        if (response.ok) {
            alert(t('auth.password_changed'));
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
        } else {
            const error = await response.json();
            alert(error.detail || t('common.operation_failed'));
        }
    } catch (error) {
        alert(t('common.error'));
    }

    return false;
}

document.addEventListener('DOMContentLoaded', () => {
    loadProfile();
    loadStats();
});
</script>
{% endblock %}
