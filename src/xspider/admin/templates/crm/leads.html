{% extends "base.html" %}

{% block title %}{{ _("crm.leads") }} - xspider Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/admin/crm">{{ _("crm.title") }}</a></li>
                <li class="breadcrumb-item active">{{ _("crm.leads") }}</li>
            </ol>
        </nav>
        <h2><i class="bi bi-people"></i> {{ _("crm.leads") }}</h2>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLeadModal">
            <i class="bi bi-plus-lg"></i> {{ _("crm.add_lead") }}
        </button>
        <a href="/admin/crm" class="btn btn-outline-secondary">
            <i class="bi bi-kanban"></i> {{ _("crm.kanban") }}
        </a>
    </div>
</div>

<!-- Filters -->
<div class="row mb-3">
    <div class="col-md-3">
        <select class="form-select" id="stage-filter" onchange="loadLeads()">
            <option value="">{{ _("common.all") }}</option>
            <option value="new_lead">{{ _("crm.new_lead") }}</option>
            <option value="contacted">{{ _("crm.contacted") }}</option>
            <option value="replied">{{ _("crm.replied") }}</option>
            <option value="converted">{{ _("crm.converted") }}</option>
            <option value="lost">{{ _("crm.lost") }}</option>
        </select>
    </div>
    <div class="col-md-4">
        <input type="text" class="form-control" id="search-input" placeholder="{{ _('common.search') }}" onkeyup="loadLeads()">
    </div>
</div>

<!-- Leads Table -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>{{ _("crm.twitter_handle") }}</th>
                        <th>{{ _("crm.stage") }}</th>
                        <th>{{ _("crm.source") }}</th>
                        <th>{{ _("crm.tags") }}</th>
                        <th>{{ _("crm.last_activity") }}</th>
                        <th>{{ _("common.actions") }}</th>
                    </tr>
                </thead>
                <tbody id="leads-table-body">
                    <tr>
                        <td colspan="7" class="text-center py-4">{{ _("common.loading") }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Lead Modal -->
<div class="modal fade" id="addLeadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("crm.add_lead") }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="return addLead(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{{ _("crm.twitter_handle") }}</label>
                        <div class="input-group">
                            <span class="input-group-text">@</span>
                            <input type="text" class="form-control" id="lead-handle" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _("crm.source") }}</label>
                        <input type="text" class="form-control" id="lead-source">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _("crm.tags") }}</label>
                        <input type="text" class="form-control" id="lead-tags" placeholder="crypto, defi, investor">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _("common.notes") }}</label>
                        <textarea class="form-control" id="lead-notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("common.cancel") }}</button>
                    <button type="submit" class="btn btn-primary">{{ _("crm.add_lead") }}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadLeads() {
    const stageFilter = document.getElementById('stage-filter').value;
    const searchInput = document.getElementById('search-input').value;

    let url = '/api/crm/leads/?';
    const params = [];
    if (stageFilter) params.push(`stage=${stageFilter}`);
    if (searchInput) params.push(`search=${encodeURIComponent(searchInput)}`);
    url += params.join('&');

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load leads');

        const data = await response.json();
        renderLeads(data.leads || data);
    } catch (error) {
        console.error('Error loading leads:', error);
        document.getElementById('leads-table-body').innerHTML =
            `<tr><td colspan="7" class="text-center text-danger">${t('common.error')}</td></tr>`;
    }
}

function renderLeads(leads) {
    const tbody = document.getElementById('leads-table-body');

    if (!leads || leads.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">${t('crm.no_leads')}</td></tr>`;
        return;
    }

    tbody.innerHTML = leads.map(lead => {
        const stageBadge = getStageBadge(lead.stage);
        const tags = (lead.tags || []).slice(0, 3).map(t => `<span class="badge bg-light text-dark me-1">${t}</span>`).join('');

        return `
            <tr>
                <td>${lead.id}</td>
                <td>
                    <img src="${lead.profile_image_url || '/static/img/default-avatar.png'}"
                         class="rounded-circle me-2" width="24" height="24" alt="">
                    @${lead.twitter_handle}
                </td>
                <td>${stageBadge}</td>
                <td>${lead.source || '-'}</td>
                <td>${tags || '-'}</td>
                <td>${lead.last_activity_at ? formatTimeAgo(lead.last_activity_at) : formatTimeAgo(lead.created_at)}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                ${t('crm.move_to')}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="updateStage(${lead.id}, 'new_lead')">${t('crm.new_lead')}</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateStage(${lead.id}, 'contacted')">${t('crm.contacted')}</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateStage(${lead.id}, 'replied')">${t('crm.replied')}</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateStage(${lead.id}, 'converted')">${t('crm.converted')}</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateStage(${lead.id}, 'lost')">${t('crm.lost')}</a></li>
                            </ul>
                        </div>
                        <button class="btn btn-outline-danger" onclick="deleteLead(${lead.id})" title="${t('common.delete')}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function getStageBadge(stage) {
    const badges = {
        'new_lead': `<span class="badge bg-secondary">${t('crm.new_lead')}</span>`,
        'contacted': `<span class="badge bg-primary">${t('crm.contacted')}</span>`,
        'replied': `<span class="badge bg-warning text-dark">${t('crm.replied')}</span>`,
        'converted': `<span class="badge bg-success">${t('crm.converted')}</span>`,
        'lost': `<span class="badge bg-danger">${t('crm.lost')}</span>`
    };
    return badges[stage] || stage;
}

function formatTimeAgo(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);

    if (diff < 60) return t('time.just_now');
    if (diff < 3600) return t('time.minutes_ago').replace('{n}', Math.floor(diff / 60));
    if (diff < 86400) return t('time.hours_ago').replace('{n}', Math.floor(diff / 3600));
    return t('time.days_ago').replace('{n}', Math.floor(diff / 86400));
}

async function addLead(event) {
    event.preventDefault();

    const data = {
        twitter_handle: document.getElementById('lead-handle').value,
        source: document.getElementById('lead-source').value,
        tags: document.getElementById('lead-tags').value.split(',').map(t => t.trim()).filter(t => t),
        notes: document.getElementById('lead-notes').value
    };

    try {
        const response = await fetch('/api/crm/leads/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addLeadModal')).hide();
            loadLeads();
        } else {
            const error = await response.json();
            alert(error.detail || t('common.operation_failed'));
        }
    } catch (error) {
        alert(t('common.error'));
    }

    return false;
}

async function updateStage(leadId, newStage) {
    try {
        const response = await fetch(`/api/crm/leads/${leadId}/stage`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stage: newStage })
        });

        if (response.ok) {
            loadLeads();
        }
    } catch (error) {
        alert(t('common.error'));
    }
}

async function deleteLead(leadId) {
    if (!confirm(t('crm.confirm_delete'))) return;

    try {
        const response = await fetch(`/api/crm/leads/${leadId}`, { method: 'DELETE' });
        if (response.ok) {
            loadLeads();
        }
    } catch (error) {
        alert(t('common.error'));
    }
}

document.addEventListener('DOMContentLoaded', loadLeads);
</script>
{% endblock %}
