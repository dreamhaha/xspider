{% extends "base.html" %}

{% block title %}{{ _("credits.title") }} - xspider{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-coin"></i> {{ _("credits.title") }}</h2>
        <p class="text-muted">{{ _("credits.description") }}</p>
    </div>
</div>

<div class="row">
    <!-- Balance Card -->
    <div class="col-md-4 mb-4">
        <div class="card bg-primary text-white h-100">
            <div class="card-body text-center">
                <h6>{{ _("credits.current_balance") }}</h6>
                <h1 class="display-4" id="current-balance">-</h1>
                <p class="mb-0">{{ _("credits.title") }}</p>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="col-md-8 mb-4">
        <div class="row h-100">
            <div class="col-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="text-muted">{{ _("credits.type_recharge") }}</h6>
                        <h3 class="text-success" id="total-recharged">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="text-muted">{{ _("searches.credits_used") }}</h6>
                        <h3 class="text-danger" id="total-spent">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="text-muted">{{ _("credits.type_search") }}</h6>
                        <h3 id="search-spent">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="text-muted">{{ _("credits.type_analysis") }}</h6>
                        <h3 id="llm-spent">-</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transaction History -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-clock-history"></i> {{ _("credits.transaction_history") }}</span>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary active" onclick="filterTransactions('')">{{ _("common.all") }}</button>
            <button class="btn btn-outline-success" onclick="filterTransactions('recharge')">{{ _("credits.type_recharge") }}</button>
            <button class="btn btn-outline-primary" onclick="filterTransactions('search')">{{ _("credits.type_search") }}</button>
            <button class="btn btn-outline-info" onclick="filterTransactions('llm_call')">{{ _("credits.type_analysis") }}</button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>{{ _("credits.date") }}</th>
                        <th>{{ _("credits.type") }}</th>
                        <th>{{ _("credits.amount") }}</th>
                        <th>{{ _("credits.balance_after") }}</th>
                        <th>{{ _("users.description") }}</th>
                    </tr>
                </thead>
                <tbody id="transactions-table-body">
                    <tr>
                        <td colspan="5" class="text-center py-4">{{ _("common.loading") }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
<nav class="mt-3" id="pagination-nav"></nav>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilter = '';
const pageSize = 20;

async function loadSummary() {
    try {
        const response = await fetch('/api/credits/summary');
        if (!response.ok) throw new Error('Failed to load summary');

        const data = await response.json();

        document.getElementById('current-balance').textContent = data.current_balance;
        document.getElementById('total-recharged').textContent = '+' + data.total_recharged;
        document.getElementById('total-spent').textContent = '-' + data.total_spent.total;
        document.getElementById('search-spent').textContent = data.total_spent.search;
        document.getElementById('llm-spent').textContent = data.total_spent.llm;
    } catch (error) {
        console.error('Error loading summary:', error);
    }
}

async function loadTransactions(page = 1) {
    currentPage = page;

    try {
        const response = await fetch(`/api/credits/history?page=${page}&page_size=${pageSize}`);
        if (!response.ok) throw new Error('Failed to load transactions');

        const data = await response.json();
        renderTransactions(data.transactions);
        renderPagination(data.total, data.page, data.page_size);
    } catch (error) {
        console.error('Error loading transactions:', error);
        document.getElementById('transactions-table-body').innerHTML =
            `<tr><td colspan="5" class="text-center text-danger">${t('common.error')}</td></tr>`;
    }
}

function renderTransactions(transactions) {
    const tbody = document.getElementById('transactions-table-body');

    let filtered = transactions;
    if (currentFilter) {
        filtered = transactions.filter(tx => tx.type === currentFilter);
    }

    if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">${t('credits.no_transactions')}</td></tr>`;
        return;
    }

    tbody.innerHTML = filtered.map(tx => {
        const amountClass = tx.amount >= 0 ? 'text-success' : 'text-danger';
        const amountSign = tx.amount >= 0 ? '+' : '';
        const typeBadge = getTypeBadge(tx.type);

        return `
            <tr>
                <td>${formatDate(tx.created_at)}</td>
                <td>${typeBadge}</td>
                <td class="${amountClass} fw-bold">${amountSign}${tx.amount}</td>
                <td>${tx.balance_after}</td>
                <td>${tx.description || '-'}</td>
            </tr>
        `;
    }).join('');
}

function getTypeBadge(type) {
    const badges = {
        'recharge': `<span class="badge bg-success">${t('credits.type_recharge')}</span>`,
        'search': `<span class="badge bg-primary">${t('credits.type_search')}</span>`,
        'llm_call': `<span class="badge bg-info">${t('credits.type_analysis')}</span>`,
        'refund': `<span class="badge bg-warning">${t('credits.type_admin')}</span>`
    };
    return badges[type] || `<span class="badge bg-secondary">${type}</span>`;
}

function formatDate(dateStr) {
    return new Date(dateStr).toLocaleString();
}

function filterTransactions(filter) {
    currentFilter = filter;

    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    loadTransactions(1);
}

function renderPagination(total, page, pageSize) {
    const totalPages = Math.ceil(total / pageSize);
    const nav = document.getElementById('pagination-nav');

    if (totalPages <= 1) {
        nav.innerHTML = '';
        return;
    }

    let html = '<ul class="pagination">';

    html += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadTransactions(${page - 1})">${t('common.back')}</a>
    </li>`;

    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        html += `<li class="page-item ${i === page ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadTransactions(${i})">${i}</a>
        </li>`;
    }

    html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadTransactions(${page + 1})">Next</a>
    </li>`;

    html += '</ul>';
    nav.innerHTML = html;
}

document.addEventListener('DOMContentLoaded', () => {
    loadSummary();
    loadTransactions();
});
</script>
{% endblock %}
