{% extends "base.html" %}

{% block title %}Credits - xspider{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-coin"></i> Credits</h2>
        <p class="text-muted">View your credit balance and transaction history</p>
    </div>
</div>

<div class="row">
    <!-- Balance Card -->
    <div class="col-md-4 mb-4">
        <div class="card bg-primary text-white h-100">
            <div class="card-body text-center">
                <h6>Current Balance</h6>
                <h1 class="display-4" id="current-balance">-</h1>
                <p class="mb-0">credits</p>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="col-md-8 mb-4">
        <div class="row h-100">
            <div class="col-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="text-muted">Total Recharged</h6>
                        <h3 class="text-success" id="total-recharged">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="text-muted">Total Spent</h6>
                        <h3 class="text-danger" id="total-spent">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="text-muted">Search Credits</h6>
                        <h3 id="search-spent">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="text-muted">LLM Credits</h6>
                        <h3 id="llm-spent">-</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transaction History -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-clock-history"></i> Transaction History</span>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary active" onclick="filterTransactions('')">All</button>
            <button class="btn btn-outline-success" onclick="filterTransactions('recharge')">Recharge</button>
            <button class="btn btn-outline-primary" onclick="filterTransactions('search')">Search</button>
            <button class="btn btn-outline-info" onclick="filterTransactions('llm_call')">LLM</button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Balance After</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="transactions-table-body">
                    <tr>
                        <td colspan="5" class="text-center py-4">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
<nav class="mt-3" id="pagination-nav"></nav>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilter = '';
const pageSize = 20;

async function loadSummary() {
    try {
        const response = await fetch('/api/credits/summary');
        if (!response.ok) throw new Error('Failed to load summary');

        const data = await response.json();

        document.getElementById('current-balance').textContent = data.current_balance;
        document.getElementById('total-recharged').textContent = '+' + data.total_recharged;
        document.getElementById('total-spent').textContent = '-' + data.total_spent.total;
        document.getElementById('search-spent').textContent = data.total_spent.search;
        document.getElementById('llm-spent').textContent = data.total_spent.llm;
    } catch (error) {
        console.error('Error loading summary:', error);
    }
}

async function loadTransactions(page = 1) {
    currentPage = page;

    try {
        const response = await fetch(`/api/credits/history?page=${page}&page_size=${pageSize}`);
        if (!response.ok) throw new Error('Failed to load transactions');

        const data = await response.json();
        renderTransactions(data.transactions);
        renderPagination(data.total, data.page, data.page_size);
    } catch (error) {
        console.error('Error loading transactions:', error);
        document.getElementById('transactions-table-body').innerHTML =
            '<tr><td colspan="5" class="text-center text-danger">Error loading transactions</td></tr>';
    }
}

function renderTransactions(transactions) {
    const tbody = document.getElementById('transactions-table-body');

    // Filter if needed
    let filtered = transactions;
    if (currentFilter) {
        filtered = transactions.filter(tx => tx.type === currentFilter);
    }

    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No transactions found</td></tr>';
        return;
    }

    tbody.innerHTML = filtered.map(tx => {
        const amountClass = tx.amount >= 0 ? 'text-success' : 'text-danger';
        const amountSign = tx.amount >= 0 ? '+' : '';
        const typeBadge = getTypeBadge(tx.type);

        return `
            <tr>
                <td>${formatDate(tx.created_at)}</td>
                <td>${typeBadge}</td>
                <td class="${amountClass} fw-bold">${amountSign}${tx.amount}</td>
                <td>${tx.balance_after}</td>
                <td>${tx.description || '-'}</td>
            </tr>
        `;
    }).join('');
}

function getTypeBadge(type) {
    const badges = {
        'recharge': '<span class="badge bg-success">Recharge</span>',
        'search': '<span class="badge bg-primary">Search</span>',
        'llm_call': '<span class="badge bg-info">LLM</span>',
        'refund': '<span class="badge bg-warning">Refund</span>'
    };
    return badges[type] || `<span class="badge bg-secondary">${type}</span>`;
}

function formatDate(dateStr) {
    return new Date(dateStr).toLocaleString();
}

function filterTransactions(filter) {
    currentFilter = filter;

    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    loadTransactions(1);
}

function renderPagination(total, page, pageSize) {
    const totalPages = Math.ceil(total / pageSize);
    const nav = document.getElementById('pagination-nav');

    if (totalPages <= 1) {
        nav.innerHTML = '';
        return;
    }

    let html = '<ul class="pagination">';

    html += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadTransactions(${page - 1})">Previous</a>
    </li>`;

    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        html += `<li class="page-item ${i === page ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadTransactions(${i})">${i}</a>
        </li>`;
    }

    html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadTransactions(${page + 1})">Next</a>
    </li>`;

    html += '</ul>';
    nav.innerHTML = html;
}

document.addEventListener('DOMContentLoaded', () => {
    loadSummary();
    loadTransactions();
});
</script>
{% endblock %}
